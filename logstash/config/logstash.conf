input {
	tcp {
		port => 5000
		type => analytic_logs
	}

	tcp {
		port => 5001
	}

}

# # Add your filters here

filter {
	if [type] == "analytic_logs" {
		## Maching QueryStatsSummary lines of log and extracting data
		grok {
			pattern => ["\[%{GREEDYDATA:machineName}\] \[%{LOGLEVEL:loglevel}\] %{TIMESTAMP_ISO8601:logTimestampString} \[%{JAVACLASS:javaclass}\] \[%{GREEDYDATA:runnerName}\] \[%{UUID:previousCorrelationId}?\] - ",
						"\[Partition:%{WORD:partitionId}\]",
						"\[Source:%{GREEDYDATA:logSource}?\]",
						"\[UserName:%{WORD:userName}?\]",
						"\[ClientAddress:/%{HOSTPORT:clientAddress}?\]",
						"\[Request:%{GREEDYDATA:request}\]",
						"\[RowsCount:%{BASE10NUM:rowsCount}\]",
						"\[ServerElapsedTime:%{BASE10NUM:serverElapsedTime}?\]",
						"\[PacketExchangeElapsedTime:%{BASE10NUM:packetExchangeElapsedTime}?\]",
						"\[TotalElapsedTime:%{BASE10NUM:totalElapsedTime}\]",
						"\[CorrelationId:%{UUID:correlationId}?\]",
						"-(%{GREEDYDATA:uncategorized_line})?",
						"(%{GREEDYDATA:unparsed_line})?"]
			
			break_on_match => false
		}
		
		## Converting string datetime to timestamp
		date {
			match => ["logTimestampString", "YYYY-MM-dd HH:mm:ss,SSS"]
			target => "@logTimestamp"
		}
		## converting string to integer and removing unused field
		mutate {
			convert => {
				"rowsCount" => "integer"
				"serverElapsedTime" => "integer"
				"packetExchangeElapsedTime" => "integer"
				"totalElapsedTime" => "integer"
			}
			remove_field => ["logTimestampString", "logTimestampString.raw"]
		}

	} else {
		xml {
			source => "message"
			target => "parsed"
		}
		split {
			field => "[parsed][testcase]"
			add_field => {
				id => "%{[parsed][testcase][name]}-%{[parsed][timestamp]}"
				name => "%{[parsed][testcase][name]}"
				classname => "%{[parsed][testcase][classname]}"
				duration => "%{[parsed][testcase][time]}"
				beginTimestamp => "%{[parsed][timestamp]}"
				target => "testcase"
			}
		}
		mutate {
			convert => {
				"duration" => "float"
			}
			# # get rid of the extra fields we don't need
			remove_field => ["message", "parsed", "host", "port"]
		}
		date {
			locale => "en"
			match => ["beginTimestamp", "YYYY-MM-dd'T'HH:mm:ss"]
			timezone => "America/Los_Angeles"
			target => "beginTimestamp"
		}
	}
}


# # Add your filters here

output {
	if [type] == "analytic_logs" {
		elasticsearch {
			hosts => "elasticsearch:9200"
		}
	}
	else  {
		elasticsearch {
			hosts => "elasticsearch:9200"
			index => "regression-tests-%{+YYYY.MM.dd}"
		}
		stdout { codec => rubydebug }
 	}
}